name: Manual Build Test Capture

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: Private source repository (owner/name)
        required: true
        type: string
      source_ref:
        description: Source ref or commit SHA
        required: true
        type: string
      artifact_name:
        description: Artifact name for package download
        required: true
        default: weasel-package
        type: string
      arch:
        description: Build arch
        required: true
        default: x64
        type: choice
        options:
          - x86
          - x64
          - arm64
      configuration:
        description: Build configuration
        required: true
        default: release
        type: choice
        options:
          - debug
          - release
      run_effect_tests:
        description: Execute effect test script
        required: true
        default: true
        type: boolean
      run_click_tests:
        description: Execute click automation test script
        required: true
        default: true
        type: boolean
      run_feedback_governance:
        description: Execute feedback governance pipeline
        required: true
        default: true
        type: boolean
      run_visual_capture:
        description: Execute visual capture script
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  build-test-capture:
    runs-on: windows-2022
    timeout-minutes: 120
    steps:
      - name: Checkout public build repo
        uses: actions/checkout@v4

      - name: Setup SSH key for private source clone
        shell: pwsh
        env:
          SOURCE_REPO_SSH_KEY: ${{ secrets.SOURCE_REPO_SSH_KEY }}
        run: |
          if (-not $env:SOURCE_REPO_SSH_KEY) { throw 'Missing SOURCE_REPO_SSH_KEY secret.' }
          New-Item -ItemType Directory -Path "$env:USERPROFILE/.ssh" -Force | Out-Null
          $keyPath = "$env:USERPROFILE/.ssh/id_source_repo"
          $keyText = $env:SOURCE_REPO_SSH_KEY -replace "`r", ""
          [System.IO.File]::WriteAllText($keyPath, $keyText, [System.Text.Encoding]::ASCII)
          @"
          Host github.com
            HostName github.com
            User git
            IdentityFile $keyPath
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
          "@ | Set-Content -Path "$env:USERPROFILE/.ssh/config" -Encoding ascii

      - name: Clone private source repo
        shell: pwsh
        run: |
          $repo = '${{ inputs.source_repo }}'
          $ref = '${{ inputs.source_ref }}'
          git clone --recurse-submodules "git@github.com:$repo.git" source
          cd source
          git checkout $ref
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Setup MSVC toolchain
        uses: ilammy/msvc-dev-cmd@v1
        with:
          sdk: 10.0.19041.0

      - name: Build from private source
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/build.ps1 -Arch '${{ inputs.arch }}' -Configuration '${{ inputs.configuration }}' -OutputDir 'artifacts/package' -StrictBuild

      - name: Setup and start Weasel IME
        if: ${{ inputs.run_click_tests || inputs.run_visual_capture }}
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/setup_weasel_ime.ps1 -ArtifactDir 'artifacts/package' -SetupOption '/s'

      - name: Run click flow tests
        if: ${{ inputs.run_click_tests }}
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/run_click_flow_tests.ps1 -ArtifactDir 'artifacts/package' -OutputDir 'artifacts/click'

      - name: Run feedback governance pipeline
        if: ${{ inputs.run_feedback_governance }}
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/run_feedback_pipeline.ps1 -EventsLog 'artifacts/click/click_events.jsonl' -OutputDir 'artifacts/governance'

      - name: Run effect tests
        if: ${{ inputs.run_effect_tests && inputs.run_click_tests && inputs.run_feedback_governance }}
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/run_effect_tests.ps1 -ArtifactDir 'artifacts/package' -ReportDir 'artifacts/reports' -EventsLog 'artifacts/click/click_events.jsonl' -ClickReport 'artifacts/click/click_flow_report.json' -GovernanceDir 'artifacts/governance'

      - name: Capture visual flow
        if: ${{ inputs.run_visual_capture }}
        shell: pwsh
        working-directory: source
        run: |
          ./tool/ci/capture_visual_flow.ps1 -OutputDir 'artifacts/visual' -StrictUi

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: source/artifacts/package
          if-no-files-found: error
          retention-days: 1

      - name: Upload test report artifact
        if: ${{ inputs.run_effect_tests && inputs.run_click_tests && inputs.run_feedback_governance }}
        uses: actions/upload-artifact@v4
        with:
          name: effect-test-report
          path: source/artifacts/reports
          if-no-files-found: error
          retention-days: 1

      - name: Upload visual story artifact
        if: ${{ inputs.run_visual_capture }}
        uses: actions/upload-artifact@v4
        with:
          name: visual-story
          path: source/artifacts/visual
          if-no-files-found: error
          retention-days: 1

      - name: Upload click flow artifact
        if: ${{ inputs.run_click_tests }}
        uses: actions/upload-artifact@v4
        with:
          name: click-flow-report
          path: source/artifacts/click
          if-no-files-found: error
          retention-days: 1

      - name: Upload governance artifact
        if: ${{ inputs.run_feedback_governance }}
        uses: actions/upload-artifact@v4
        with:
          name: feedback-governance
          path: source/artifacts/governance
          if-no-files-found: error
          retention-days: 1
